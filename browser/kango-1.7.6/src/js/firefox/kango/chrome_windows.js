var utils=require("kango/utils"),func=utils.func,array=utils.array,object=utils.object,EventTarget=utils.EventTarget;function ChromeWindows(){EventTarget.call(this);this._unloadListeners=[];this.init()}
ChromeWindows.prototype=object.extend(EventTarget,{event:{WINDOW_LOAD:"WindowLoad",WINDOW_UNLOAD:"WindowUnload"},init:function(){this._watchWindows();this._watchNotCompletelyLoadedWindows()},dispose:function(){this.removeAllEventListeners();Services.ww.unregisterNotification(this._windowWatcher);this._runUnloaders();this._unloadListeners=[]},_runUnloaders:function(){array.forEach(this._unloadListeners,function(a){try{a()}catch(b){kango.console.reportError(b,"unloader")}})},_removeUnloadListener:function(a){for(var b=
this._unloadListeners,c=0;c<b.length;c++)if(b[c]==a){b.splice(c,1);break}},_listenLoadEvent:function(a,b,c){var d=function(){a.removeEventListener("load",d,!0);b.call(c||null,a)};a.addEventListener("load",d,!0)},_watchWindows:function(){this._windowWatcher=func.bind(function(a,b){"domwindowopened"==b?this._listenLoadEvent(a,function(a){"navigator:browser"==a.document.documentElement.getAttribute("windowtype")&&this.fireEvent(this.event.WINDOW_LOAD,{window:a})},this):"domwindowclosed"==b&&"navigator:browser"==
a.document.documentElement.getAttribute("windowtype")&&this.fireEvent(this.event.WINDOW_UNLOAD,{window:a})},this);Services.ww.registerNotification(this._windowWatcher)},_watchNotCompletelyLoadedWindows:function(){for(var a=Services.wm.getEnumerator("navigator:browser");a.hasMoreElements();){var b=a.getNext();"complete"!=b.document.readyState&&this._listenLoadEvent(b,function(a){this.fireEvent(this.event.WINDOW_LOAD,{window:a})},this)}},getHiddenWindow:function(){return(Services.appShell||Cc["@mozilla.org/appshell/appShellService;1"].getService(Ci.nsIAppShellService)).hiddenDOMWindow},
getLoadedChromeWindows:function(){for(var a=[],b=Services.wm.getEnumerator("navigator:browser");b.hasMoreElements();){var c=b.getNext();"complete"==c.document.readyState&&a.push(c)}return a},getChromeWindows:function(){for(var a=[],b=Services.wm.getEnumerator("navigator:browser");b.hasMoreElements();){var c=b.getNext();a.push(c)}return a},getMostRecentChromeWindow:function(){return Services.wm.getMostRecentWindow("navigator:browser")},getActiveWindow:function(){return Services.ww.activeWindow},registerContainerUnloader:function(a,
b){var c=func.bind(function(d){d&&this._removeUnloadListener(c);b.removeEventListener("unload",c,!1);a()},this);this._unloadListeners.push(c);b.addEventListener("unload",c,!1)}});module.exports=new ChromeWindows;
