"use strict";
_kangoLoader.add("kango/browser", function(require, exports, module) {
var utils=require("kango/utils"),object=utils.object,array=utils.array,EventTarget=utils.EventTarget,IEventTarget=utils.IEventTarget,NotImplementedException=utils.NotImplementedException;function BrowserCookie(){this.path=this.hostOnly=this.domain=this.value=this.name="";this.session=this.httpOnly=this.secure=!1;this.expires=0}function BrowserBase(){EventTarget.call(this)}
BrowserBase.prototype=object.extend(EventTarget,{event:{DOCUMENT_COMPLETE:"DocumentComplete",BEFORE_NAVIGATE:"BeforeNavigate",TAB_CHANGED:"TabChanged",TAB_CREATED:"TabCreated",TAB_REMOVED:"TabRemoved",WINDOW_CHANGED:"WindowChanged"},getName:function(){throw new NotImplementedException;},cookies:{getCookies:function(a,b){throw new NotImplementedException;},getCookie:function(a,b,c){throw new NotImplementedException;},setCookie:function(a,b){throw new NotImplementedException;}},tabs:{},windows:{getAll:function(a){throw new NotImplementedException;
},getCurrent:function(a){throw new NotImplementedException;},create:function(a){throw new NotImplementedException;}}});function BrowserTabsBase(){}BrowserTabsBase.prototype={getAll:function(a){throw new NotImplementedException;},getCurrent:function(a){throw new NotImplementedException;},create:function(a){throw new NotImplementedException;},broadcastMessage:function(a,b){this.getAll(function(c){array.forEach(c,function(c){c.dispatchMessage(a,b)})})}};function IBrowserWindow(){}
IBrowserWindow.prototype={getId:function(){throw new NotImplementedException;},getTabs:function(a){throw new NotImplementedException;},getCurrentTab:function(a){throw new NotImplementedException;},isActive:function(){throw new NotImplementedException;}};function IBrowserTab(){}
IBrowserTab.prototype={getId:function(){throw new NotImplementedException;},getUrl:function(){throw new NotImplementedException;},getTitle:function(){throw new NotImplementedException;},getDOMWindow:function(){throw new NotImplementedException;},isActive:function(){throw new NotImplementedException;},isPrivate:function(){throw new NotImplementedException;},navigate:function(a){throw new NotImplementedException;},activate:function(){throw new NotImplementedException;},dispatchMessage:function(a,b){throw new NotImplementedException;
},close:function(){throw new NotImplementedException;}};function getPublicApi(){return utils.createApiWrapper(module.exports,BrowserBase.prototype,IEventTarget.prototype)};








var utils=require("kango/utils"),func=utils.func,array=utils.array,object=utils.object;function ObjectTracker(){this._lastId=0;this._objs={}}ObjectTracker.prototype={_geNextId:function(){return this._lastId++},add:function(a){var b=this.getId(a);return-1==b?(b=this._geNextId(),this._objs[b]=a,b):-1},remove:function(a){a=this.getId(a);return-1!=a?delete this._objs[a]:!1},getId:function(a){for(var b in this._objs)if(this._objs.hasOwnProperty(b)&&this._objs[b]===a)return b;return-1}};
function BrowserTabs(){}BrowserTabs.prototype=object.extend(BrowserTabsBase,{getAll:function(a){for(var b=[],e=safari.application.browserWindows,c=0;c<e.length;c++)for(var f=e[c].tabs,d=0;d<f.length;d++)b.push(browser.getKangoTab(f[d]));a(b)},getCurrent:function(a){a(browser.getKangoTab(safari.application.activeBrowserWindow.activeTab))},create:function(a){safari.application.activeBrowserWindow.openTab(("undefined"!=typeof a.focused?a.focused:1)?"foreground":"background").url=a.url}});
function Browser(){BrowserBase.call(this);this.tabs=new BrowserTabs;this._tabTracker=new ObjectTracker;this._windowTracker=new ObjectTracker;safari.application.addEventListener("beforeNavigate",func.bind(this._onBeforeNavigate,this),!0);safari.application.addEventListener("navigate",func.bind(this._onNavigate,this),!0);safari.application.addEventListener("activate",func.bind(this._onActivate,this),!0);safari.application.addEventListener("open",func.bind(this._onOpen,this),!0);safari.application.addEventListener("close",
func.bind(this._onClose,this),!0)}
Browser.prototype=object.extend(BrowserBase,{_onOpen:function(a){a.target instanceof SafariBrowserTab&&(a=this.getKangoTab(a.target),this.fireEvent(this.event.TAB_CREATED,{target:a,tabId:a.getId()}))},_onClose:function(a){a.target instanceof SafariBrowserTab?(a=a.target,this.fireEvent(this.event.TAB_REMOVED,{tabId:this._tabTracker.getId(a)}),this._tabTracker.remove(a)):a.target instanceof SafariBrowserWindow&&this._windowTracker.remove(a.target)},_onActivate:function(a){a.target instanceof SafariBrowserTab?
(a=this.getKangoTab(a.target),this.fireEvent(this.event.TAB_CHANGED,{url:a.getUrl(),title:a.getTitle(),target:a,tabId:a.getId()})):a.target instanceof SafariBrowserWindow&&this.fireEvent(this.event.WINDOW_CHANGED,{target:this.getKangoWindow(a.target)})},_onBeforeNavigate:function(a){var b=this.getKangoTab(a.target);this.fireEvent(this.event.BEFORE_NAVIGATE,{url:a.url||"",target:b})},_onNavigate:function(a){a=this.getKangoTab(a.target);this.fireEvent(this.event.DOCUMENT_COMPLETE,{url:a.getUrl(),title:a.getTitle(),
target:a})},getKangoTab:function(a){var b=this._tabTracker.getId(a);-1==b&&(b=this._tabTracker.add(a));return new BrowserTab(a,b)},getKangoWindow:function(a){var b=this._windowTracker.getId(a);-1==b&&(b=this._windowTracker.add(a));return new BrowserWindow(a,b)},getName:function(){return"safari"},windows:{getAll:function(a){a(array.map(safari.application.browserWindows,function(a){return browser.getKangoWindow(a)}))},getCurrent:function(a){a(browser.getKangoWindow(safari.application.activeBrowserWindow))},
create:function(a){safari.application.openBrowserWindow().activeTab.url=a.url}}});function BrowserWindow(a,b){this._window=a;this._id=b}BrowserWindow.prototype={getId:function(){return this._id},getTabs:function(a){a(array.map(this._window.tabs,function(a){return browser.getKangoTab(a)}))},getCurrentTab:function(a){a(browser.getKangoTab(this._window.activeTab))},isActive:function(){return safari.application.activeBrowserWindow==this._window}};function BrowserTab(a,b){this._tab=a;this._id=b}
BrowserTab.prototype={getId:function(){return this._id},getUrl:function(){return this._tab.url||""},getTitle:function(){return this._tab.title||""},getDOMWindow:function(){return null},isActive:function(){return this._tab==this._tab.browserWindow.activeTab},isPrivate:function(){return"undefined"!=typeof safari.application.privateBrowsing?safari.application.privateBrowsing.enabled:!1},navigate:function(a){this._tab.url=a},activate:function(){var a=this._tab.browserWindow;safari.application.activeBrowserWindow!=
a&&a.activate();a.activeTab!=this._tab&&this._tab.activate()},dispatchMessage:function(a,b){return"undefined"!=typeof this._tab.page?(this._tab.page.dispatchMessage(a,b),!0):!1},close:function(){this._tab.close()}};var browser=module.exports=new Browser;module.exports.getPublicApi=getPublicApi;module.exports.BrowserTab=BrowserTab;

});