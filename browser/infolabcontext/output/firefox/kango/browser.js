var utils=require("kango/utils"),object=utils.object,array=utils.array,EventTarget=utils.EventTarget,IEventTarget=utils.IEventTarget,NotImplementedException=utils.NotImplementedException;function BrowserCookie(){this.path=this.hostOnly=this.domain=this.value=this.name="";this.session=this.httpOnly=this.secure=!1;this.expires=0}function BrowserBase(){EventTarget.call(this)}
BrowserBase.prototype=object.extend(EventTarget,{event:{DOCUMENT_COMPLETE:"DocumentComplete",BEFORE_NAVIGATE:"BeforeNavigate",TAB_CHANGED:"TabChanged",TAB_CREATED:"TabCreated",TAB_REMOVED:"TabRemoved",WINDOW_CHANGED:"WindowChanged"},getName:function(){throw new NotImplementedException;},cookies:{getCookies:function(a,b){throw new NotImplementedException;},getCookie:function(a,b,c){throw new NotImplementedException;},setCookie:function(a,b){throw new NotImplementedException;}},tabs:{},windows:{getAll:function(a){throw new NotImplementedException;
},getCurrent:function(a){throw new NotImplementedException;},create:function(a){throw new NotImplementedException;}}});function BrowserTabsBase(){}BrowserTabsBase.prototype={getAll:function(a){throw new NotImplementedException;},getCurrent:function(a){throw new NotImplementedException;},create:function(a){throw new NotImplementedException;},broadcastMessage:function(a,b){this.getAll(function(c){array.forEach(c,function(c){c.dispatchMessage(a,b)})})}};function IBrowserWindow(){}
IBrowserWindow.prototype={getId:function(){throw new NotImplementedException;},getTabs:function(a){throw new NotImplementedException;},getCurrentTab:function(a){throw new NotImplementedException;},isActive:function(){throw new NotImplementedException;}};function IBrowserTab(){}
IBrowserTab.prototype={getId:function(){throw new NotImplementedException;},getUrl:function(){throw new NotImplementedException;},getTitle:function(){throw new NotImplementedException;},getDOMWindow:function(){throw new NotImplementedException;},isActive:function(){throw new NotImplementedException;},isPrivate:function(){throw new NotImplementedException;},navigate:function(a){throw new NotImplementedException;},activate:function(){throw new NotImplementedException;},dispatchMessage:function(a,b){throw new NotImplementedException;
},close:function(){throw new NotImplementedException;}};function getPublicApi(){return utils.createApiWrapper(module.exports,BrowserBase.prototype,IEventTarget.prototype)};








var utils=require("kango/utils"),object=utils.object,func=utils.func;
function TabApiProxy(k){var a=require("kango/console"),f=require("kango/storage").storage,c=require("kango/i18n"),h=require("kango/invoke_async"),e=require("kango/message_target"),g=[];this.xhr={send:function(){var b=require("kango/xhr");return b.send.apply(b,arguments)}};this.console={log:function(){return a.log.apply(a,arguments)},warn:function(){return a.warn.apply(a,arguments)},error:function(){return a.error.apply(a,arguments)}};this.browser={getName:function(){return require("kango/browser").getName()}};
this.io={getResourceUrl:function(b){return require("kango/io").getResourceUrl(b)}};this.tab={isPrivate:function(){return k.isPrivate()}};this.storage={setItem:function(b,d){return f.setItem(b,d)},getItem:function(b){return f.getItem(b)},removeItem:function(b){return f.removeItem(b)},getKeys:function(){return f.getKeys()},clear:function(){return f.clear()}};this.i18n={getMessage:function(){return c.getMessage.apply(c,arguments)},getMessages:function(){return c.getMessages.apply(c,arguments)},getCurrentLocale:function(){return c.getCurrentLocale.apply(c,
arguments)}};this.getExtensionInfo=function(){return require("kango/extension_info").getRawData()};var n=this.dispatchMessage=function(b,d){var m=require("kango/messaging"),a={name:b,data:null!=d?object.sanitize(d):d,origin:"tab",source:k,target:k};return m.dispatchMessageEx(a)},l=this.addEventListener=function(b,d){if("message"==b){for(var a=0;a<g.length;a++)if(g[a]==d)return;g.push(d)}};this.fireEvent=function(b,a){if("message"==b){a.source&&a.target||(a.source=a.target=this);for(var c=0;c<g.length;c++)g[c](a)}};
h=new h(l,n,utils.func.invoke,func.bind(a.log,a));this.invokeAsync=h.invokeAsync;this.invokeAsyncCallback=h.invokeAsyncCallback;e=new e(l);this.addMessageListener=func.bind(e.addMessageListener,e);this.removeMessageListener=func.bind(e.removeMessageListener,e)};








var utils=require("kango/utils"),func=utils.func,array=utils.array,object=utils.object,chromeWindows=require("kango/chrome_windows"),io=require("kango/io");
function ExposedTabProxy(a,c){function b(a){return a&&object.isObject(a)?d.exposeObject(a,"r",c):a}TabApiProxy.call(this,a);var d=require("kango/lang"),e=require("kango/xhr"),h=require("kango/storage").storage,f=require("kango/i18n");this.getExtensionInfo=function(){return b(require("kango/extension_info").getRawData())};this.storage.getItem=function(a){return b(h.getItem(a))};this.storage.getKeys=function(){return b(h.getKeys())};this.i18n.getMessages=function(){return b(f.getMessages.apply(f,arguments))};
this.xhr.send=function(a,b){a.sanitizeData=!0;e.send(a,function(a){a&&(a=d.exposeObject(a,"rw",c));b(a)})};var g=null;this.fireEvent=func.decorate(this.fireEvent,function(a,c){var d=c[0],e=c[1];e.source=e.target=null;e=b(e);e.source=e.target=g;a.call(this,d,e)});g=d.exposeObject(this,"r",c);0<=Services.vc.compare(Services.appinfo.platformVersion,"34")&&(Cu.exportFunction(func.bind(this.xhr.send,g.xhr),g.xhr,{defineAs:"send",allowCallbacks:!0}),Cu.exportFunction(func.bind(this.invokeAsyncCallback,
g),g,{defineAs:"invokeAsyncCallback",allowCallbacks:!0}),Cu.exportFunction(func.bind(this.invokeAsync,g),g,{defineAs:"invokeAsync",allowCallbacks:!0}),Cu.exportFunction(func.bind(this.addMessageListener,g),g,{defineAs:"addMessageListener",allowCallbacks:!0}),Cu.exportFunction(func.bind(this.removeMessageListener,g),g,{defineAs:"removeMessageListener",allowCallbacks:!0}));this.wrappedObject=g;return this}function WebProgressListener(a){this._callback=a}
WebProgressListener.prototype={QueryInterface:function(a){if(a.equals(Ci.nsIWebProgressListener)||a.equals(Ci.nsISupportsWeakReference)||a.equals(Ci.nsISupports))return this;throw Cr.NS_NOINTERFACE;},onProgressChange:function(){},onStatusChange:function(){},onSecurityChange:function(){},onLocationChange:function(){},onStateChange:function(a,c,b,d){d=Ci.nsIWebProgressListener;b&d.STATE_START&&b&d.STATE_IS_DOCUMENT&&(a={url:c.QueryInterface(Ci.nsIChannel).originalURI.spec,window:a.DOMWindow},this._callback(a))}};
function BrowserTabs(){}
BrowserTabs.prototype=object.extend(BrowserTabsBase,{getAll:function(a){for(var c=[],b=browser.getBrowsers(),d=0;d<b.length;d++)c=c.concat(browser.getTabs(b[d]));a(c)},getCurrent:function(a){browser.windows.getCurrent(function(c){c.getCurrentTab(function(b){a(b)})})},create:function(a){var c="undefined"==typeof a.focused||a.focused,b="undefined"!=typeof a.reuse&&a.reuse,d=chromeWindows.getMostRecentChromeWindow().gBrowser,e=null;if(b)for(b=0;b<d.browsers.length;b++)if(d.getBrowserAtIndex(b).currentURI.spec==a.url){e=
d.tabContainer.childNodes[b];break}null==e&&(e=d.addTab(a.url));c&&(d.selectedTab=e)}});function Browser(){BrowserBase.call(this);this.tabs=new BrowserTabs;this._tabs={};this._documentLoadListener=null;this.init()}
Browser.prototype=object.extend(BrowserBase,{init:function(){array.forEach(chromeWindows.getLoadedChromeWindows(),function(a){this._listenChromeWindowEvents(a)},this);chromeWindows.addEventListener(chromeWindows.event.WINDOW_LOAD,func.bind(function(a){this._listenChromeWindowEvents(a.window)},this));this._addDocumentObserver()},dispose:function(){this._removeDocumentObserver();this.removeAllEventListeners();this._tabs={}},_addDocumentObserver:function(){var a=this._documentLoadListener=func.bind(this._onPageLoad,
this),c=this;this._observer={observe:function(b,d,e){"document-element-inserted"==d&&b&&b.defaultView&&(b=b.defaultView)&&c._isScriptableUrl(b.document.URL)&&(b.addEventListener("DOMContentLoaded",a,!0),b.addEventListener("load",a,!0),c.fireEvent("DocumentInserted",{window:b}))}};Services.obs.addObserver(c._observer,"document-element-inserted",!1)},_removeDocumentObserver:function(){Services.obs.removeObserver(this._observer,"document-element-inserted")},_isScriptableUrl:function(a){return 0==a.indexOf("http")||
0==a.indexOf("file")},_listenChromeWindowEvents:function(a){var c=new WebProgressListener(func.bind(this._onPageBeforeNavigate,this));a.gBrowser.addProgressListener(c);chromeWindows.registerContainerUnloader(function(){a.gBrowser.removeProgressListener(c)},a);var b=func.bind(function(a){var b=a.target;0!=b.URL.indexOf("about:blank")&&0!=b.URL.indexOf(io.getExtensionFileUrl(""))||this._onPageLoad(a)},this);a.gBrowser.addEventListener("DOMContentLoaded",b,!0);chromeWindows.registerContainerUnloader(function(){a.gBrowser.removeEventListener("DOMContentLoaded",
b,!0)},a);var d=func.bind(this._onTabSelect,this);a.gBrowser.tabContainer.addEventListener("TabSelect",d,!0);chromeWindows.registerContainerUnloader(function(){a.gBrowser.tabContainer.removeEventListener("TabSelect",d,!0)},a);var e=func.bind(this._onTabOpen,this);a.gBrowser.tabContainer.addEventListener("TabOpen",e,!0);chromeWindows.registerContainerUnloader(function(){a.gBrowser.tabContainer.removeEventListener("TabOpen",e,!0)},a);var h=func.bind(this._onTabClose,this);a.gBrowser.tabContainer.addEventListener("TabClose",
h,!0);chromeWindows.registerContainerUnloader(function(){a.gBrowser.tabContainer.removeEventListener("TabClose",h,!0)},a);var f=func.bind(this._onWindowActivate,this);a.addEventListener("activate",f,!0);chromeWindows.registerContainerUnloader(function(){a.removeEventListener("activate",f,!0)},a)},_onPageBeforeNavigate:function(a){var c=a.window;c.frameElement||this.fireEvent(this.event.BEFORE_NAVIGATE,{url:a.url,target:this.getTab(this.getTabFromWindow(c.top||c))})},_onPageLoad:function(a){a=a.target;
var c=a.defaultView;c.removeEventListener("load",this._documentLoadListener,!0);c.removeEventListener("DOMContentLoaded",this._documentLoadListener,!0);if(a instanceof c.HTMLDocument){var b=this.getTab(this.getTabFromWindow(c));b.deleteTabProxy(c);b={url:b.getUrl(),title:b.getTitle(),target:b};a.defaultView.frameElement||this.fireEvent(this.event.DOCUMENT_COMPLETE,b);b.window=c;this.fireEvent("DocumentLoaded",b)}},_getTabId:function(a){return a.linkedPanel.toString().split("panel").pop()},_removeTab:function(a){return delete this._tabs[a]},
_onTabSelect:function(a){a=this.getTab(a.target);this.fireEvent(this.event.TAB_CHANGED,{url:a.getUrl(),title:a.getTitle(),target:a,tabId:a.getId()})},_onTabOpen:function(a){a=this.getTab(a.target);this.fireEvent(this.event.TAB_CREATED,{target:a,tabId:a.getId()})},_onTabClose:function(a){a=this._getTabId(a.target);this._removeTab(a);this.fireEvent(this.event.TAB_REMOVED,{tabId:a})},_onWindowActivate:function(a){a=new BrowserWindow(a.target);this.fireEvent(this.event.WINDOW_CHANGED,{target:a,windowId:a.getId()})},
getTabFromWindow:function(a){a=a.top||a;for(var c=this.getBrowsers(),b=0;b<c.length;b++){var d=c[b],e=d.getBrowserIndexForDocument(a.document);if(-1!=e)return d.tabContainer.childNodes[e]}return null},getBrowsers:function(){return array.map(chromeWindows.getLoadedChromeWindows(),function(a){return a.gBrowser})},getTabs:function(a){return array.map(a.tabContainer.childNodes,function(a){return browser.getTab(a)})},getTab:function(a){var c=this._getTabId(a);"undefined"==typeof this._tabs[c]&&(this._tabs[c]=
new BrowserTab(a,c),a=this._tabs[c].getChromeWindow(),chromeWindows.registerContainerUnloader(func.bind(function(){this._removeTab(c)},this),a));return this._tabs[c]},getSandboxForWindow:function(a,c){return this.getTab(this.getTabFromWindow(a)).getSandboxForWindow(a,c)},getName:function(){return"firefox"},cookies:{getCookies:function(a,c){var b=[],d=Cc["@mozilla.org/cookiemanager;1"].getService(Ci.nsICookieManager),e=Cc["@mozilla.org/network/io-service;1"].getService(Ci.nsIIOService).newURI(a,null,
null);if(null!=e)for(var h=e.host,e=e.path||"/",d=d.enumerator;d.hasMoreElements();){var f=d.getNext().QueryInterface(Ci.nsICookie2);h.indexOf(f.host)+f.host.length==h.length&&0==e.indexOf(f.path)&&b.push({name:f.name,value:f.value,domain:f.host,hostOnly:f.isDomain,path:f.path,secure:f.isSecure,httpOnly:f.isHttpOnly,session:f.isSession,expires:f.expires})}c(b)},getCookie:function(a,c,b){this.getCookies(a,function(a){for(var e=0;e<a.length;e++)a[e].name==c&&b(a[e]);b(null)})},setCookie:function(a,
c){var b=c.name,d=c.value,e=c.expires||null,h=c.secure||!1,f=c.httpOnly||!1,g=Cc["@mozilla.org/cookiemanager;1"].getService(Ci.nsICookieManager2),k=Cc["@mozilla.org/network/io-service;1"].getService(Ci.nsIIOService).newURI(a,null,null);null!=k&&g.add(k.host,k.path,b,d,h,f,h,e)}},windows:{getAll:function(a){a(array.map(chromeWindows.getLoadedChromeWindows(),function(a){return new BrowserWindow(a)}))},getCurrent:function(a){a(new BrowserWindow(chromeWindows.getMostRecentChromeWindow()))},create:function(a){chromeWindows.getMostRecentChromeWindow().open(a.url)}}});
function BrowserWindow(a){this._gBrowser=a.gBrowser;this._window=a}BrowserWindow.prototype={getTabs:function(a){a(browser.getTabs(this._gBrowser))},getCurrentTab:function(a){for(var c=this._gBrowser.tabContainer,b=null,d=0;d<c.childNodes.length&&(b=c.childNodes[d],!b.selected);d++);a(browser.getTab(b))},getId:function(){return this._window.QueryInterface(Ci.nsIInterfaceRequestor).getInterface(Ci.nsIDOMWindowUtils).outerWindowID},isActive:function(){return chromeWindows.getActiveWindow()==this._window}};
function BrowserTab(a,c){this._tabElem=a;this._id=c;this._proxies=[]}
BrowserTab.prototype={_getBrowserForTab:function(a){return a.linkedBrowser},_getBrowser:function(){return this._getBrowserForTab(this._tabElem)},_isWindowPrivate:function(a){try{return a.QueryInterface(Ci.nsIInterfaceRequestor).getInterface(Ci.nsIWebNavigation).QueryInterface(Ci.nsILoadContext).usePrivateBrowsing}catch(c){}try{return!!a.docShell.QueryInterface(Ci.nsILoadContext).usePrivateBrowsing}catch(b){}return!1},getChromeWindow:function(){return this._getBrowser().ownerDocument.defaultView},deleteTabProxy:function(a,
c){for(var b=0;b<this._proxies.length;b++)if(this._proxies[b].window==a&&this._proxies[b].namespace==c)return this._proxies.splice(b,1),!0;return!1},getSandboxForWindow:function(a,c){for(var b=0;b<this._proxies.length;b++)if(this._proxies[b].window==a&&this._proxies[b].namespace==c)return this._proxies[b].sandbox;var b=new Cu.Sandbox(a,{sandboxPrototype:a,wantXrays:!0}),d=new ExposedTabProxy(this,b);b.kango=d.wrappedObject;this._proxies.push({window:a,proxy:d,sandbox:b,namespace:c});chromeWindows.registerContainerUnloader(func.bind(function(){this.deleteTabProxy(a,
c)},this),a);return b},getId:function(){return this._id},getUrl:function(){return this.getDOMWindow().document.URL||""},getTitle:function(){return this.getDOMWindow().document.title||""},getDOMWindow:function(){return this._getBrowser().contentWindow},isActive:function(){return this._tabElem.selected},isPrivate:function(){return this._isWindowPrivate(this.getDOMWindow())},navigate:function(a){this._getBrowser().loadURI(a)},activate:function(){var a=this.getChromeWindow();a.gBrowser.selectedTab=this._tabElem;
a.focus()},dispatchMessage:function(a,c){if(0<this._proxies.length){var b={name:a,data:c,origin:"background",source:null,target:null};array.forEach(this._proxies,function(a){a.proxy.fireEvent("message",b)});return!0}return!1},close:function(){this.getChromeWindow().gBrowser.removeTab(this._tabElem)}};var browser=module.exports=new Browser;module.exports.BrowserTab=BrowserTab;module.exports.getPublicApi=getPublicApi;
